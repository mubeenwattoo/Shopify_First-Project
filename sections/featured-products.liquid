{% comment %}
  Homepage section: products with Add to cart. Submitting adds to cart and redirects to /cart.
{% endcomment %}

{% if section.settings.collection != blank %}
  {% assign collection = collections[section.settings.collection] %}
{% else %}
  {% assign collection = collections.all %}
{% endif %}

<div class="featured-products container mx-auto px-4 py-8">
  {% if section.settings.heading != blank %}
    <h2 class="text-2xl font-semibold mb-6">{{ section.settings.heading }}</h2>
  {% endif %}
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
    {% for product in collection.products limit: section.settings.products_to_show %}
      <div class="border rounded-lg overflow-hidden flex flex-col">
        <a href="{{ product.url }}" class="block aspect-square bg-gray-100">
          {% if product.featured_image %}
            <img
              src="{{ product.featured_image | image_url: width: 400 }}"
              alt="{{ product.featured_image.alt | default: product.title | escape }}"
              width="400"
              height="400"
              class="w-full h-full object-cover"
              loading="lazy"
            >
          {% endif %}
        </a>
        <div class="p-4 flex flex-col flex-1">
          <a href="{{ product.url }}" class="font-medium text-gray-900 hover:underline">{{ product.title }}</a>
          <p class="mt-1 text-gray-700">{{ product.price | money }}</p>
          {% form 'product', product, class: 'mt-auto pt-3 product-form-ajax' %}
            <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">
            <input type="hidden" name="quantity" value="1">
            <button type="submit" class="add-to-cart-btn w-full mt-2 px-4 py-2 bg-black text-white text-sm font-medium rounded hover:opacity-90">
              Add to cart
            </button>
          {% endform %}
        </div>
      </div>
    {% else %}
      <p class="col-span-full text-gray-500">No products in this collection.</p>
    {% endfor %}
  </div>
</div>

<script>
(function() {
  var section = document.querySelector('.featured-products');
  if (!section) return;
  section.querySelectorAll('.product-form-ajax').forEach(function(form) {
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      var btn = form.querySelector('.add-to-cart-btn');
      if (btn) { btn.disabled = true; btn.textContent = 'Addingâ€¦'; }
      fetch(form.action || '/cart/add', {
        method: 'POST',
        body: new FormData(form),
        credentials: 'same-origin',
        redirect: 'manual'
      }).then(function(res) {
        window.location.href = '/cart';
      }).catch(function() {
        window.location.href = '/cart';
      });
    });
  });
})();
</script>

{% schema %}
{
  "name": "Featured products",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Products"
    },
    {
      "type": "collection",
      "id": "collection",
      "label": "Collection",
      "info": "Leave blank to show all products."
    },
    {
      "type": "range",
      "id": "products_to_show",
      "label": "Products to show",
      "min": 2,
      "max": 24,
      "step": 1,
      "default": 8
    }
  ],
  "presets": [
    {
      "name": "Featured products",
      "category": "Products"
    }
  ]
}
{% endschema %}
